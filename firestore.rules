rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: is this user an admin for a given company?
    function isCompanyAdmin(companyId) {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return user.role == 'admin' && user.companyId == companyId;
    }

    // Users: own profile
    match /users/{userId} {
      // Anyone can read their own doc
      allow read: if request.auth != null && request.auth.uid == userId;

      // Create: only on sign-up (auth UID must match, role must be participant)
      allow create: if request.auth != null && request.auth.uid == userId
        && request.resource.data.role == 'participant';

      // Update: can't change role or companyId
      allow update: if request.auth != null && request.auth.uid == userId
        && request.resource.data.role == resource.data.role
        && request.resource.data.companyId == resource.data.companyId;

      // Admins can read employees in their company
      allow read: if request.auth != null
        && resource.data.companyId != null
        && isCompanyAdmin(resource.data.companyId);
    }

    // Daily logs: own data + company admin
    match /users/{userId}/dailyLogs/{day} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null
        && get(/databases/$(database)/documents/users/$(userId)).data.companyId != null
        && isCompanyAdmin(get(/databases/$(database)/documents/users/$(userId)).data.companyId);
    }

    // Assessments: own data + company admin
    match /users/{userId}/assessments/{type} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null
        && get(/databases/$(database)/documents/users/$(userId)).data.companyId != null
        && isCompanyAdmin(get(/databases/$(database)/documents/users/$(userId)).data.companyId);
    }

    // Companies: admin of that company
    match /companies/{companyId} {
      allow read, write: if request.auth != null && isCompanyAdmin(companyId);
    }

    // Invite codes: authenticated can read, admins can write
    match /inviteCodes/{code} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
