<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#1a2332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Build More Margin Challenge</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/app.css">
</head>
<body>
  <script>
    if (location.hostname === 'dashboard.buildmoremargin.com') {
      location.replace('/dashboard.html');
    }
  </script>

  <!-- Offline Banner -->
  <div id="offline-banner" style="display:none;position:fixed;top:0;left:0;right:0;background:var(--gold);color:var(--navy);text-align:center;padding:6px;font-size:0.8rem;font-weight:600;z-index:300;">
    You're offline — some features may be limited
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--navy);">
    <div style="text-align:center;color:var(--white);">
      <div class="spinner" style="border-top-color:var(--green);margin-bottom:16px;"></div>
      <div style="font-weight:600;">Build More Margin</div>
    </div>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen" style="display:none;">
    <div class="logo">Build More Margin</div>
    <div class="tagline">21-Day Challenge</div>
    <div class="auth-box">
      <h2 id="auth-title">Sign In</h2>
      <div id="auth-error" class="error-msg"></div>
      <form id="auth-form">
        <div id="name-group" class="form-group" style="display:none;">
          <label for="auth-name">Full Name</label>
          <input type="text" id="auth-name" placeholder="Your name" autocomplete="name">
        </div>
        <div class="form-group">
          <label for="auth-email">Email</label>
          <input type="email" id="auth-email" placeholder="you@example.com" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="auth-password">Password</label>
          <input type="password" id="auth-password" placeholder="Min 6 characters" required minlength="6" autocomplete="current-password">
        </div>
        <div id="invite-group" class="form-group" style="display:none;">
          <label for="auth-invite">Invite Code (optional)</label>
          <input type="text" id="auth-invite" placeholder="From your employer">
        </div>
        <button type="submit" class="btn btn-primary btn-full" id="auth-submit">Sign In</button>
      </form>
      <div class="auth-toggle">
        <a href="#" id="auth-forgot-link" style="font-size:0.85rem;">Forgot password?</a>
      </div>
      <div id="reset-sent" style="display:none;text-align:center;color:var(--green);font-size:0.85rem;padding:8px;">Reset email sent! Check your inbox.</div>
      <div class="auth-toggle">
        <span id="auth-toggle-text">Don't have an account?</span>
        <a href="#" id="auth-toggle-link">Sign Up</a>
      </div>
    </div>
  </div>

  <!-- iOS Install Prompt -->
  <div id="ios-install" style="display:none;position:fixed;bottom:70px;left:16px;right:16px;background:var(--white);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow-md);z-index:150;text-align:center;border:1px solid var(--border);">
    <div style="font-weight:600;margin-bottom:6px;">Install this app</div>
    <div style="font-size:0.8rem;color:var(--slate);">Tap the share button <span style="font-size:1.1em;">&#8593;</span> then "Add to Home Screen"</div>
    <button onclick="document.getElementById('ios-install').style.display='none';localStorage.setItem('iosInstallDismissed','1');" style="margin-top:8px;background:none;border:none;color:var(--green);font-weight:600;cursor:pointer;font-size:0.85rem;">Got it</button>
  </div>

  <!-- Main App -->
  <div id="app" style="display:none;">
    <header class="app-header">
      <h1>Build More Margin</h1>
      <div class="subtitle">21-Day Challenge</div>
    </header>

    <div class="app-container">
      <!-- Pre-Assessment Survey (shown on Day 0 if not completed) -->
      <div id="view-survey" class="view" style="display:none;">
        <div style="height:16px;"></div>
        <div id="survey-container"></div>
      </div>

      <!-- Today View -->
      <div id="view-today" class="view active">
        <div style="height:16px;"></div>

        <!-- Completion banner (hidden until Day 21 + post-survey done) -->
        <div id="completion-banner" class="card" style="display:none;text-align:center;background:linear-gradient(135deg,var(--navy),var(--navy-light));color:var(--white);">
          <h2 style="margin-bottom:8px;">Challenge Complete!</h2>
          <p style="color:var(--text-light);margin-bottom:12px;">You finished all 21 days. That puts you ahead of 95% of people who start something like this.</p>
          <p style="font-weight:600;color:var(--green);">Your Fusion Formula is built. Now sustain it.</p>
        </div>

        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <button class="btn btn-outline" id="day-prev" style="padding:8px 12px;font-size:0.8rem;" disabled>&larr;</button>
            <div class="day-indicator" style="flex:1;justify-content:center;margin-bottom:0;">
              <div class="day-number" id="today-day-num">0</div>
              <div>
                <h3 id="today-title">Loading...</h3>
                <div class="phase-label" id="today-phase"></div>
              </div>
            </div>
            <button class="btn btn-outline" id="day-next" style="padding:8px 12px;font-size:0.8rem;" disabled>&rarr;</button>
          </div>
          <div style="text-align:center;margin-top:8px;">
            <span class="pillar-badge" id="today-pillar-badge" style="display:none;"></span>
            <a href="#" id="day-back-to-today" style="display:none;font-size:0.8rem;color:var(--green);margin-left:8px;">Back to Today</a>
          </div>
        </div>

        <!-- Streak & Motivation -->
        <div id="streak-bar" style="display:none;display:flex;align-items:center;justify-content:space-between;padding:8px 16px;margin-bottom:16px;">
          <div id="streak-msg" style="font-size:0.85rem;font-weight:600;color:var(--gold);"></div>
          <button class="btn btn-outline" id="share-btn" style="padding:6px 14px;font-size:0.75rem;display:none;">Share</button>
        </div>

        <!-- Video -->
        <div class="card" id="today-video-card" style="display:none;">
          <h3>Today's Video</h3>
          <div class="video-container">
            <div class="video-placeholder" id="today-video-placeholder">Video coming soon</div>
            <video id="today-video" controls style="display:none;"></video>
          </div>
        </div>

        <!-- Exercise -->
        <div class="card">
          <h3>Today's Exercise</h3>
          <p id="today-exercise"></p>
        </div>

        <!-- Description -->
        <div class="card">
          <p id="today-description"></p>
        </div>

        <!-- Daily Check-in -->
        <div class="card" id="checkin-card">
          <h3>Daily Check-in</h3>
          <form id="checkin-form">
            <div class="check-item">
              <input type="checkbox" id="checkin-completed">
              <label for="checkin-completed">I completed today's exercise</label>
            </div>

            <div class="form-group" style="margin-top:12px;">
              <label>Stress Level: <span id="stress-val" style="color:var(--green);font-size:1.1em;">5</span>/10</label>
              <input type="range" id="checkin-stress" min="1" max="10" value="5" oninput="document.getElementById('stress-val').textContent=this.value">
              <div class="range-labels"><span>Low</span><span>High</span></div>
            </div>

            <div class="form-group">
              <label>Sleep Quality: <span id="sleep-val" style="color:var(--green);font-size:1.1em;">5</span>/10</label>
              <input type="range" id="checkin-sleep" min="1" max="10" value="5" oninput="document.getElementById('sleep-val').textContent=this.value">
              <div class="range-labels"><span>Poor</span><span>Great</span></div>
            </div>

            <div class="form-group">
              <label for="checkin-steps">Steps / Movement Minutes</label>
              <input type="number" id="checkin-steps" placeholder="e.g. 5000">
            </div>

            <div class="check-item">
              <input type="checkbox" id="checkin-breathing">
              <label for="checkin-breathing">Did breathing exercise</label>
            </div>

            <div class="check-item">
              <input type="checkbox" id="checkin-meal">
              <label for="checkin-meal">Logged a meal</label>
            </div>

            <button type="submit" class="btn btn-primary btn-full" id="checkin-submit">Save Check-in</button>
            <div id="checkin-saved" style="display:none;text-align:center;color:var(--green);font-weight:600;padding:12px;">Saved!</div>
          </form>
        </div>
      </div>

      <!-- Progress View -->
      <div id="view-progress" class="view">
        <div style="height:16px;"></div>
        <div class="card">
          <h2>Your Progress</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="progress-day">0</div>
              <div class="stat-label">Day</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="progress-streak">0</div>
              <div class="stat-label">Streak</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="progress-pct">0%</div>
              <div class="stat-label">Complete</div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>

        <!-- Phase progress -->
        <div class="card">
          <h3>Challenge Phases</h3>
          <div id="phase-list"></div>
        </div>

        <!-- Trends -->
        <div class="card">
          <h3>Trends</h3>
          <div id="trend-chart"></div>
        </div>

        <!-- Daily log history -->
        <div class="card">
          <h3>Check-in History</h3>
          <div id="log-history"></div>
        </div>
      </div>

      <!-- Breathing View -->
      <div id="view-breathing" class="view">
        <div style="height:16px;"></div>
        <div class="card">
          <h2>4x4x4x4 Breathing</h2>
          <p>A 2-minute stress reset technique. Breathe in for 4 counts, hold for 4, breathe out for 4, hold for 4.</p>
        </div>
        <div class="card breathing-container">
          <div class="breathing-circle" id="breathing-circle">
            <div>
              <div class="breathing-text" id="breathing-text">Ready</div>
              <div class="breathing-count" id="breathing-count"></div>
            </div>
          </div>
          <div class="breathing-cycle" id="breathing-cycle">Tap Start to begin</div>
          <div style="margin-top:16px;">
            <button class="btn btn-primary" id="breathing-start">Start</button>
            <button class="btn btn-outline" id="breathing-stop" style="display:none;">Stop</button>
          </div>
        </div>
      </div>

      <!-- Savings View -->
      <div id="view-savings" class="view">
        <div style="height:16px;"></div>
        <div class="card">
          <h2>Peace of Mind Account</h2>
          <p>Track your $500 savings goal — your financial safety net.</p>
        </div>
        <div class="card savings-display">
          <div class="savings-amount" id="savings-amount">$0</div>
          <div class="savings-goal">of $500 goal</div>
          <div class="progress-bar savings-bar">
            <div class="progress-fill" id="savings-bar-fill" style="width:0%"></div>
          </div>
          <div class="form-group" style="margin-top:16px;">
            <label for="savings-input">Add to Savings</label>
            <div style="display:flex;gap:8px;">
              <input type="number" id="savings-input" placeholder="Amount" min="0" step="0.01" style="flex:1;">
              <button class="btn btn-primary" id="savings-add">Add</button>
            </div>
          </div>
          <div id="savings-history" style="margin-top:12px;"></div>
        </div>
      </div>

      <!-- Profile View -->
      <div id="view-profile" class="view">
        <div style="height:16px;"></div>
        <div class="card">
          <h2>Profile</h2>
          <p id="profile-name"></p>
          <p id="profile-email" style="color:var(--slate);font-size:0.875rem;"></p>
          <p id="profile-type" style="color:var(--slate);font-size:0.875rem;"></p>
        </div>
        <div class="card">
          <h3>Challenge Settings</h3>
          <div class="form-group">
            <label for="profile-start-date">Challenge Start Date</label>
            <input type="date" id="profile-start-date">
          </div>
          <button class="btn btn-outline btn-full" id="profile-save">Save Settings</button>
        </div>
        <div style="margin-top:16px;">
          <button class="btn btn-outline btn-full" id="btn-signout" style="color:var(--red);border-color:var(--red);">Sign Out</button>
        </div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <button class="nav-item active" data-view="today">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Today
      </button>
      <button class="nav-item" data-view="progress">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Progress
      </button>
      <button class="nav-item" data-view="breathing">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        Breathe
      </button>
      <button class="nav-item" data-view="savings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
        Savings
      </button>
      <button class="nav-item" data-view="profile">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Profile
      </button>
    </nav>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- App modules -->
  <script src="/js/firebase-config.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/challenge.js"></script>
  <script src="/js/checkin.js"></script>
  <script src="/js/progress.js"></script>
  <script src="/js/breathing-timer.js"></script>
  <script src="/js/peace-of-mind.js"></script>
  <script src="/js/survey.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
